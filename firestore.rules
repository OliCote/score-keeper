rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /Users/{userId} {
      // Allow the user to update a document only if that document doesn't change the permission
      allow update: if (!request.resource.data.diff(resource.data).affectedKeys()
      .hasAny(['permission'])) && 
      request.auth.uid == userId;

      allow create: if request.auth != null;

      allow delete: if request.auth.uid == userId;

      allow read: if request.auth != null
    }
    match /Logs/{logId} {
      allow update: if false;

      allow create: if request.auth != null;

      allow delete: if request.auth != null &&
      getUser(request.auth.uid).permission == 'admin';

      allow read: if request.auth != null &&
      getUser(request.auth.uid).permission == 'admin';
    }

    function getUser(id) {
      return get(/databases/$(database)/documents/Users/$(id)).data;
    }
  }
}